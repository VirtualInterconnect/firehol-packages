include $(TOPDIR)/rules.mk

PKG_NAME:=firehol
PKG_VERSION:=<<VER>>
PKG_RELEASE:=1

PKG_BUILD_DIR:=$(BUILD_DIR)/firehol-$(PKG_VERSION)
PKG_SOURCE:=firehol-$(PKG_VERSION).tar.bz2
PKG_SOURCE_URL:=<<URL>>
PKG_MD5SUM:=<<MD5>>
PKG_CAT:=bzcat

include $(INCLUDE_DIR)/package.mk

define Package/firehol
	SECTION:=net
	CATEGORY:=Network
	PKGARCH=all
	DEPENDS:=+bash +ip-full +bash +coreutils-fold +flock \
		+grep +ipset +tc \
		+kmod-ifb +kmod-sched +kmod-dummy +kmod-sched-connmark \
		+iptables-mod-extra +iptables-mod-conntrack-extra \
		+iptables-mod-ipopt
	TITLE:=firehol and fireqos - firewalling and QOS for humans
	URL:=https://firehol.org/
endef

define Package/firehol/description
	FireHOL - a firewall for humans
	FireQOS - traffic management for humans
	Related tools
endef

CONFIGURE_ARGS += \
	--disable-doc \
	--disable-man \
	--disable-firehol-wizard \
	--disable-link-balancer \
	--disable-update-ipsets \
	--disable-vnetbuild

CONFIGURE_VARS += \
	IPRANGE_VERSION=1.0.3 \
	BASH_VERSION=4 \
	BASH_VERSION_PATH=/bin/bash \

# This list generated by inspecting the results of running
# ./configure on an actual openwrt router - there's no point
# in detecting the locations on the build host.
CONFIGURE_VARS += \
	BASENAME=/usr/bin/basename \
	BRIDGE=x \
	CAT=/bin/cat \
	CHMOD=/bin/chmod \
	CHOWN=/bin/chown \
	CP=/bin/cp \
	CURL=x \
	CUT=/usr/bin/cut \
	DATE=/bin/date \
	DIFF=x \
	DIRNAME=/usr/bin/dirname \
	DOT=x \
	EGREP=/usr/bin/grep\ -E \
	ENV=x \
	EXPR=/usr/bin/expr \
	FIND=/usr/bin/find \
	FLOCK=/usr/bin/flock \
	FOLD=/usr/bin/fold \
	FUNZIP=x \
	JQ=x \
	GAWK=/usr/bin/awk \
	GIT=x \
	GREP=/usr/bin/grep \
	HEAD=/usr/bin/head \
	HOSTNAME=x \
	IP6TABLES=/usr/sbin/ip6tables \
	IP6TABLES_RESTORE=/usr/sbin/ip6tables-restore \
	IP6TABLES_SAVE=/usr/sbin/ip6tables-save \
	IP=/usr/sbin/ip \
	IPRANGE=x \
	IPSET=/usr/sbin/ipset \
	IPTABLES=/usr/sbin/iptables \
	IPTABLES_RESTORE=/usr/sbin/iptables-restore \
	IPTABLES_SAVE=/usr/sbin/iptables-save \
	JQ=x \
	LN=x \
	LOGGER=/usr/bin/logger \
	LS=/bin/ls \
	LSMOD=/usr/sbin/lsmod \
	MKDIR=/bin/mkdir \
	MKTEMP=/bin/mktemp \
	MODPROBE=/usr/sbin/modprobe\ -q \
	MORE=/usr/bin/less \
	MV=/bin/mv \
	NEATO=x \
	NFACCT=x \
	PING6=/bin/ping\ -6 \
	PING=/bin/ping \
	READLINK=/usr/bin/readlink \
	RENICE=: \
	RMMOD=/usr/sbin/rmmod \
	RM=/bin/rm \
	SCREEN=x \
	SED=/bin/sed \
	SEQ=/usr/bin/seq \
	SH=x \
	SLEEP=/bin/sleep \
	SORT=/usr/bin/sort \
	SS=x \
	STTY=: \
	SYSCTL=/sbin/sysctl \
	TAIL=/usr/bin/tail \
	TAR=x \
	TCPDUMP=/usr/sbin/tcpdump \
	TC=/usr/sbin/tc \
	TOUCH=/bin/touch \
	TPUT=x \
	TRACEROUTE=x \
	TR=/usr/bin/tr \
	UNAME=/bin/uname \
	UNIQ=/usr/bin/uniq \
	UNZIP=x \
	WC=/usr/bin/wc \
	WGET=x \
	WHOISx= \
	ZCAT=/bin/zcat

define Build/Configure
  $(call Build/Configure/Default)
endef

define Package/firehol/install
	$(INSTALL_DIR) $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/sbin/firehol $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/sbin/fireqos $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/sbin/functions.common $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/sbin/services.common $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/sbin/services.firehol $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/sbin/services.fireqos $(1)/usr/lib/firehol/$(PKG_VERSION)
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/sbin/install.config $(1)/usr/lib/firehol/$(PKG_VERSION)

# Remove any programs that we do not expect to find and change
# the default spool directory to one that will persist, enabling
# the fast startup functionality to work.
	$(INSTALL_DIR) $(1)/etc/firehol-spool/
	sed -i -e 's/"x"/""/' -e '/FIREHOL_SPOOL_DIR=/s:=.*:=/etc/firehol-spool:'  $(1)/usr/lib/firehol/$(PKG_VERSION)/install.config

	$(INSTALL_DIR) $(1)/etc/firehol/
	$(INSTALL_DIR) $(1)/etc/firehol/services
	$(INSTALL_CONF) files/firehol-defaults.conf $(1)/etc/firehol/
	$(INSTALL_CONF) files/firehol.conf.example $(1)/etc/firehol/
	$(INSTALL_CONF) files/fireqos.conf.example $(1)/etc/firehol/

	$(INSTALL_DIR) $(1)/sbin
	ln -s /usr/lib/firehol/$(PKG_VERSION)/firehol $(1)/sbin/firehol
	ln -s /usr/lib/firehol/$(PKG_VERSION)/fireqos $(1)/sbin/fireqos

	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) files/firehol $(1)/etc/init.d/
	$(INSTALL_BIN) files/fireqos $(1)/etc/init.d/

	$(INSTALL_DIR) $(1)/etc/hotplug.d/iface/
	$(INSTALL_CONF) files/50-qos $(1)/etc/hotplug.d/iface/
endef

$(eval $(call BuildPackage,firehol))
